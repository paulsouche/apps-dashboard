(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{514:function(e,t,n){e.exports=n.p+"images/spinner-default.svg?d0b1f1aeccf02c5f611127680850b810"},515:function(e,t){e.exports=":host {\n  -webkit-box-flex: 1;\n  -webkit-flex: 1;\n  -ms-flex: 1;\n  flex: 1; }\n\n.dashboard-form__container {\n  padding: 16px; }\n\n.dashboard-form__feedback {\n  color: #f44336; }\n"},516:function(e,t){e.exports=":host {\n  -webkit-box-flex: 5;\n  -webkit-flex: 5;\n  -ms-flex: 5;\n  flex: 5;\n  position: relative;\n  padding: 16px; }\n\n.dashboard-table {\n  width: 100%;\n  height: 100%; }\n  /deep/ .dashboard-table__group {\n    font-size: 1.3em;\n    font-weight: 700; }\n  /deep/ .dashboard-table__sub-group {\n    font-size: 1.1em;\n    font-weight: 600; }\n  /deep/ .dashboard-table__cell {\n    color: gray; }\n"},517:function(e,t){e.exports=":host {\n  display: -webkit-box;\n  display: -webkit-flex;\n  display: -ms-flexbox;\n  display: flex;\n  -webkit-box-orient: vertical;\n  -webkit-box-direction: normal;\n  -webkit-flex-direction: column;\n  -ms-flex-direction: column;\n  flex-direction: column;\n  height: calc(100% - 64px); }\n\n.dashboard-page__spinner {\n  -webkit-box-flex: 5;\n  -webkit-flex: 5;\n  -ms-flex: 5;\n  flex: 5;\n  display: -webkit-box;\n  display: -webkit-flex;\n  display: -ms-flexbox;\n  display: flex;\n  -webkit-box-align: center;\n  -webkit-align-items: center;\n  -ms-flex-align: center;\n  align-items: center;\n  -webkit-box-pack: center;\n  -webkit-justify-content: center;\n  -ms-flex-pack: center;\n  justify-content: center; }\n\n.dashboard-page__error {\n  -webkit-box-flex: 5;\n  -webkit-flex: 5;\n  -ms-flex: 5;\n  flex: 5;\n  margin: 16px;\n  color: red;\n  text-align: center;\n  margin-top: 32px; }\n"},518:function(e){e.exports={dateEnd:"End date",dateStart:"Start date",errorRetrievingData:"An error occured during data fetch<br/>Please try to decrease dates range",expenditure:"Expenditure",invalidDate:"Invalid date {{text}}",invalidDateRange:"Invalid date range",requiredField:"Required field",revenue:"Revenue",total:"Total"}},519:function(e){e.exports={dateEnd:"Date de fin",dateStart:"Date de début",errorRetrievingData:"Une erreur est survenue pendant la récupération de la donnée...<br/>Merci d'essayer réduire la plage de dates",expenditure:"Dépenses",invalidDate:"Format de date invalide {{text}}",invalidDateRange:"Plage de dates invalides",requiredField:"Ce champs est requis",revenue:"Recettes",total:"Total"}},528:function(e,t,n){"use strict";n.r(t);var r=n(0),o=n(1),a=n(386),i=n(529),s=n(477),u=n(520),c=n(355),d=n(139),l=n(488),p=n(479),f=n(407),h=n(514),b=function(){function e(){this.src=h}return e=r.c([Object(o.Component)({selector:"spinner",template:'\n    <img\n      [src]="src"\n    />\n  '})],e)}(),m=function(){function e(e,t){this._viewContainerRef=e,this._resolver=t}return Object.defineProperty(e.prototype,"ngIf",{set:function(e){if(!e){var t=this._resolver.resolveComponentFactory(b);this._viewContainerRef.createComponent(t)}},enumerable:!0,configurable:!0}),r.c([Object(o.Input)(),r.f("design:type",Object),r.f("design:paramtypes",[Object])],e.prototype,"ngIf",null),e=r.c([Object(o.Directive)({selector:"[ngIfLoadingModel]"}),r.f("design:paramtypes",[o.ViewContainerRef,o.ComponentFactoryResolver])],e)}(),g=function(){function e(){}return e=r.c([Object(o.NgModule)({declarations:[b,m],entryComponents:[b],exports:[b,m],imports:[f.a]})],e)}(),y=n(521);var v=function(){function e(e){this.formBuilder=e,this.onDate=new o.EventEmitter}return Object.defineProperty(e.prototype,"startErrors",{get:function(){return this.formGroup.controls.start.errors},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"endErrors",{get:function(){return this.formGroup.controls.end.errors},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"formErrors",{get:function(){return this.formGroup.errors},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){this.formGroup=this.formBuilder.group({end:[this.end,a.i.required],start:[this.start,a.i.required]},{validator:function(e,t){var n=function(e){return Object.keys(e).length>0?e:null};return function(o){var a=o.controls,i=a[e],s=a[t],u=i.errors||{},c=s.errors||{};if(i.value>s.value){var d={invalidDateRange:!0};return i.setErrors(r.a({},u,d)),s.setErrors(r.a({},c,d)),s.markAsTouched(),d}return delete u.invalidDateRange,delete c.invalidDateRange,i.setErrors(n(u)),s.setErrors(n(c)),null}}("start","end")})},e.prototype.ngAfterViewInit=function(){var e=this,t=this.formGroup;this.datepickers.forEach(function(n){return n.dateInput.pipe(Object(y.a)(500)).subscribe(function(){t.valid&&e.onDate.emit(t.value)})})},r.c([Object(o.Input)(),r.f("design:type",Object)],e.prototype,"start",void 0),r.c([Object(o.Input)(),r.f("design:type",Object)],e.prototype,"end",void 0),r.c([Object(o.Output)(),r.f("design:type",Object)],e.prototype,"onDate",void 0),r.c([Object(o.ViewChildren)(i.a),r.f("design:type",o.QueryList)],e.prototype,"datepickers",void 0),e=r.c([Object(o.Component)({selector:"dashboard-form",styles:[n(515)],template:'\n    <form\n      [formGroup]="formGroup"\n    >\n      <mat-form-field\n        class="dashboard-form__container"\n      >\n        <input matInput\n          formControlName="start"\n          [matDatepicker]="dateStart"\n          [placeholder]="\'dateStart\' | translate"\n        >\n        <mat-datepicker-toggle matSuffix\n          [for]="dateStart"\n        >\n        </mat-datepicker-toggle>\n        <mat-datepicker #dateStart>\n        </mat-datepicker>\n        <mat-error\n          *ngIf="startErrors?.required && !startErrors?.matDatepickerParse"\n        >\n          {{\'requiredField\' | translate}}\n        </mat-error>\n        <mat-error\n          *ngIf="startErrors?.matDatepickerParse"\n        >\n          {{\'invalidDate\' | translate:startErrors?.matDatepickerParse}}\n        </mat-error>\n      </mat-form-field>\n\n      <mat-form-field\n        class="dashboard-form__container"\n      >\n        <input matInput\n          formControlName="end"\n          [matDatepicker]="dateEnd"\n          [placeholder]="\'dateEnd\' | translate"\n        >\n        <mat-datepicker-toggle matSuffix\n          [for]="dateEnd"\n        >\n        </mat-datepicker-toggle>\n        <mat-datepicker #dateEnd>\n        </mat-datepicker>\n        <mat-error\n          *ngIf="endErrors?.required && !endErrors?.matDatepickerParse"\n        >\n          {{\'requiredField\' | translate}}\n        </mat-error>\n        <mat-error\n          *ngIf="endErrors?.matDatepickerParse"\n        >\n          {{\'invalidDate\' | translate:endErrors?.matDatepickerParse}}\n        </mat-error>\n      </mat-form-field>\n      <span\n        *ngIf="formErrors?.invalidDateRange"\n        class="dashboard-form__feedback"\n      >\n        {{\'invalidDateRange\' | translate}}\n      </span>\n    </form>\n  '}),r.f("design:paramtypes",[a.a])],e)}(),w=n(480),x=function(){function e(e){var t=e.instant(["expenditure","revenue","total"]),n=t.expenditure,r=t.revenue,o=t.total;this.expenditureKey=n,this.revenueKey=r,this.totalField=o}return e.prototype.getDashboard=function(e){var t=this,n=this.totalField,r=this.getTableDimensions(e),o=r.cols,a=r.rows,i=r.knownExpenditureApps,s=r.knownRevenueApps,u={row:n,type:"group"},c={field:n,headerName:n};o.forEach(function(e){var t=e.field;u[t]="=ctx.sumCol('"+t+"')",a.forEach(function(e){e[t]="=ctx.sumGroup('"+e.row+"','"+t+"')",e.children.forEach(function(n){return n[t]="=ctx.sumSubGroup('"+e.row+"','"+n.row+"','"+t+"')"})})}),u[n]="=ctx.sumTable()",a.forEach(function(e){e[n]="=ctx.sumTableGroup('"+e.row+"')",e.children.forEach(function(t){t[n]="=ctx.sumTableSubGroup('"+e.row+"','"+t.row+"')",t.children.forEach(function(r){return r[n]="=ctx.sumTableRow('"+e.row+"','"+t.row+"', '"+r.row+"')"})})});var d={sumCol:function(e){return a.reduce(function(t,n){var r=n.row;return Math.round(100*t+100*d.sumGroup(r,e))/100},0)},sumGroup:function(e,n){return Math.round(100*d.sumSubGroup(e,t.revenueKey,n)-100*d.sumSubGroup(e,t.expenditureKey,n))/100},sumSubGroup:function(e,n,r){var o,a=n===t.expenditureKey?i[e]:s[e];return Object.values(a).reduce(function(e,t){return t&&(o=t[r])?Math.round(100*e+100*o)/100:e},0)},sumTable:function(){return a.reduce(function(e,t){var n=t.row;return Math.round(100*e+100*d.sumTableGroup(n))/100},0)},sumTableGroup:function(e){return Math.round(100*d.sumTableSubGroup(e,t.revenueKey)-100*d.sumTableSubGroup(e,t.expenditureKey))/100},sumTableRow:function(e,n,r){var a=n===t.expenditureKey?i[e][r]:s[e][r];return o.reduce(function(e,t){var n=t.field;return a?Math.round(100*e+100*a[n])/100:e},0)},sumTableSubGroup:function(e,n){var r=n===t.expenditureKey?i[e]:s[e];return Object.values(r).reduce(function(t,r){return r?Math.round(100*t+100*d.sumTableRow(e,n,r.row))/100:t},0)}};return{columnDefs:[{cellRenderer:"agGroupCellRenderer",field:"row",headerName:"",pinned:"left"}].concat(o,[c]),context:d,enableCellExpressions:!0,rowData:a.concat([u]),getNodeChildDetails:function(e){var t=e.row,n=e.children;return n?{children:n,expanded:!0,group:!0,key:t}:null},getRowClass:function(e){return"dashboard-table__"+e.data.type}}},e.prototype.getTableDimensions=function(e){var t=this,n=[this.expenditureKey,this.revenueKey],r=n[0],o=n[1],a={},i={},s={},u={},c=[];return{cols:e.acquisitions.concat(e.monetizations).reduce(function(e,n){var d=t.isAcquisition(n),l=t.isAcquisition(n)?{amount:n.cost,app:n.application,country:n.country,platform:n.platform}:{amount:n.revenue,app:n.game,country:n.country,platform:n.os},p=l.amount,f=l.app,h=l.country,b=l.platform;a[h]||e.push(a[h]={field:h,headerName:h});var m=i[b];m||(s[b]={},u[b]={},c.push(i[b]=m={children:[{children:[],row:r,type:"sub-group"},{children:[],row:o,type:"sub-group"}],row:b,type:"group"}));var g=d?s[b]:u[b],y=g[f];y||m.children[d?0:1].children.push(g[f]=y={row:f,type:"cell"});var v=y[h];return y[h]=Math.round(100*("number"==typeof v?v:0)+100*p)/100,e},[]),knownExpenditureApps:s,knownRevenueApps:u,rows:c}},e.prototype.isAcquisition=function(e){return!!e.platform},e=r.c([Object(o.Injectable)(),r.f("design:paramtypes",[w.b])],e)}(),j=function(){function e(e){this.mapper=e}return e.prototype.ngOnInit=function(){this.dashboard=this.mapper.getDashboard(this.detail)},r.c([Object(o.Input)(),r.f("design:type",Object)],e.prototype,"detail",void 0),e=r.c([Object(o.Component)({selector:"dashboard-table",styles:[n(516)],template:'\n    <ag-grid-angular\n      class="ag-theme-balham dashboard-table"\n      [columnDefs]="dashboard.columnDefs"\n      [context]="dashboard.context"\n      [enableCellExpressions]="dashboard.enableCellExpressions"\n      [getNodeChildDetails]="dashboard.getNodeChildDetails"\n      [getRowClass]="dashboard.getRowClass"\n      [rowData]="dashboard.rowData"\n    >\n    </ag-grid-angular>\n  '}),r.f("design:paramtypes",[x])],e)}(),D=n(406),k=new o.InjectionToken("voodooConfig"),O=function(){function e(e,t){var n=e.acquisitionKey,r=e.endPoint;if(!n||!r)throw new Error("AcquisitionRepository: project not configured ! See Readme.md for more details");this.endPoint=r,this.key=n,this.doRequest=function(e,n){return t(e,n)}}return e.prototype.getAcquisitions=function(e){return r.b(this,void 0,void 0,function(){var t,n;return r.e(this,function(r){switch(r.label){case 0:return[4,this.doRequest("https://cors-anywhere.herokuapp.com/"+this.endPoint+"/acquisition?"+this.getQueryParams(e))];case 1:if(t=r.sent(),n=t.headers,t.status>=300)throw t;switch(n.get("content-type")){case"application/json":return[2,t.json()];default:throw t}return[2]}})})},e.prototype.getQueryParams=function(e){var t=e.start,n=e.end;return["api_key="+this.key,"start="+t,"end="+n,"format=json","columns="+["cost","country","platform","application"].join()].join("&")},e=r.c([Object(o.Injectable)(),r.g(0,Object(o.Inject)(k)),r.g(1,Object(o.Inject)(D.a)),r.f("design:paramtypes",[Object,Object])],e)}(),R=function(){function e(e,t,n){this.location=n;var r=e.monetizationKey,o=e.endPoint;if(!r||!o)throw new Error("MonetizationRepository: project not configured ! See Readme.md for more details");this.endPoint=o,this.key=r,this.doRequest=function(e,n){return t(e,n)}}return e.prototype.getMonetizationss=function(e){return r.b(this,void 0,void 0,function(){var t,n;return r.e(this,function(r){switch(r.label){case 0:return[4,this.doRequest("https://cors-anywhere.herokuapp.com/"+this.endPoint+"/monetization?"+this.getQueryParams(e),{headers:{Authorization:"Bearer "+this.key,Origin:this.location.href}})];case 1:if(t=r.sent(),n=t.headers,t.status>=300)throw t;switch(n.get("content-type")){case"application/json":return[2,t.json()];default:throw t}return[2]}})})},e.prototype.getQueryParams=function(e){return["start="+e.start,"end="+e.end,"dimensions="+["country","os","game"].join(),"aggregates="+["revenue"].join()].join("&")},e=r.c([Object(o.Injectable)(),r.g(0,Object(o.Inject)(k)),r.g(1,Object(o.Inject)(D.a)),r.g(2,Object(o.Inject)(D.b)),r.f("design:paramtypes",[Object,Object,Location])],e)}(),E=function(){function e(e,t){this.acquisitionRepo=e,this.monetizationRepo=t}return e.prototype.getDashboardRange=function(){var e=new Date,t=new Date;return t.setDate(t.getDate()-1),{end:e,start:t}},e.prototype.getRealDashboardDetail=function(e){return r.b(this,void 0,void 0,function(){var t,n,o,a;return r.e(this,function(i){switch(i.label){case 0:return t=this.toApiRangeBecauseIsoStringWasTooEasy(e),[4,Promise.all([this.acquisitionRepo.getAcquisitions(t),this.monetizationRepo.getMonetizationss(t)])];case 1:return n=i.sent(),o=n[0].data,a=n[1].data,[2,r.a({},e,{acquisitions:o,monetizations:a})]}})})},e.prototype.toApiRangeBecauseIsoStringWasTooEasy=function(e){var t=e.start;return{end:""+e.end.toISOString().slice(0,10),start:""+t.toISOString().slice(0,10)}},e=r.c([Object(o.Injectable)(),r.f("design:paramtypes",[O,R])],e)}(),I=function(){function e(e){this.dashboardService=e}return e.prototype.ngOnInit=function(){return r.b(this,void 0,void 0,function(){return r.e(this,function(e){return this.getDasboardDetail(this.range=this.dashboardService.getDashboardRange()),[2]})})},e.prototype.refreshDashboard=function(e){return r.b(this,void 0,void 0,function(){return r.e(this,function(t){return this.getDasboardDetail(this.range=e),[2]})})},e.prototype.getDasboardDetail=function(e){return r.b(this,void 0,void 0,function(){var t,n;return r.e(this,function(r){switch(r.label){case 0:delete this.detail,delete this.error,r.label=1;case 1:return r.trys.push([1,3,,4]),t=this,[4,this.dashboardService.getRealDashboardDetail(e)];case 2:return t.detail=r.sent(),[3,4];case 3:return n=r.sent(),this.error=n,[3,4];case 4:return[2]}})})},e=r.c([Object(o.Component)({selector:"dashboard-page",styles:[n(517)],template:'\n    <dashboard-form\n      [end]="range.end"\n      [start]="range.start"\n      (onDate)="this.refreshDashboard($event)"\n    >\n    </dashboard-form>\n\n    <ng-container *ngIf="!detail && !error">\n      <spinner\n        class="dashboard-page__spinner"\n      >\n      </spinner>\n    </ng-container>\n\n    \x3c!-- TODO this should work --\x3e\n    <ng-container *ngIf="detail loadingModel">\n      <dashboard-table\n        [detail]="detail"\n      >\n      </dashboard-table>\n    </ng-container>\n\n    <ng-container *ngIf="error">\n      <p\n        class="dashboard-page__error"\n        [innerHTML]="\'errorRetrievingData\' | translate"\n      >\n      </p>\n    </ng-container>\n  '}),r.f("design:paramtypes",[E])],e)}(),_=n(143);function C(){return _.b}var S=n(518),q=n(519);n.d(t,"DashboardModule",function(){return P});var G=[{component:I,path:""}],P=function(){function e(e,t){e.setLocale(t)}return e=r.c([Object(o.NgModule)({declarations:[v,j,I],imports:[l.AgGridModule.withComponents([]),a.c,p.a.forRoot({en:S,fr:q}),i.b,s.c,u.b,c.h,a.h,d.a.forChild(G),g,f.a],providers:[x,E,O,R,{provide:k,useFactory:C}]}),r.g(1,Object(o.Inject)(o.LOCALE_ID)),r.f("design:paramtypes",[c.a,String])],e)}()}}]);